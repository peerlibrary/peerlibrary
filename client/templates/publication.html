<template name="publication">
  {{#if loading}}
    <div class="simple loading">
      <h2>Loading</h2>
    </div>
  {{else}}
    {{#if notfound}}
      <div class="simple notfound">
        <h2>404 Not found</h2>
        <p>Publication not found. You might lack permissions to access it.{{#unless currentPersonId}} Try signing in.{{/unless}}</p>
      </div>
    {{else}}
      <div class="viewer">
        {{> publicationMetaMenu}}
        {{> publicationScroller}}
        {{> publicationDisplay}}
        {{> annotationsControl}}
        {{> publicationAnnotations}}
      </div>
    {{/if}}
  {{/if}}
</template>

<template name="publicationMetaMenu">
  <div class="meta-menu">
    <i class="icon-menu"></i>
    <div class="meta-content">
      <p><b>{{publication.title}}</b></p>
      <p class="authors">
        {{#each publication.authors}}
          <span><a href="{{profilePath slug}}">{{displayName}}</a></span>
        {{/each}}
      </p>
      <p>Source: {{publication.source}}</p>
      <p>{{publication.createdAt}}</p>
<!--
      <div class="access-panel">
        <form class="access">
          <div class="selections">

              <label class="selection {{#if open}}selected{{/if}}" for="publication-access-open-{{publication._id}}">
                <input type="radio" value="open" name="publication-access-{{publication._id}}" id="publication-access-open-{{publication._id}}" {{#if open}}checked="checked"{{/if}} />
                <i class="icon-public"></i> Open<br/>Access
              </label>

              <label class="selection {{#if closed}}selected{{/if}}" for="publication-access-closed-{{publication._id}}">
                <input type="radio" value="closed" name="publication-access-{{publication._id}}" id="publication-access-closed-{{publication._id}}" {{#if closed}}checked="checked"{{/if}} />
                <i class="icon-closed"></i> Closed<br/>Access
              </label>

              <label class="selection {{#if private}}selected{{/if}}" for="publication-access-private-{{publication._id}}">
                <input type="radio" value="private" name="publication-access-{{publication._id}}" id="publication-access-private-{{publication._id}}" {{#if private}}checked="checked"{{/if}} />
                <i class="icon-private"></i> Private
              </label>

          </div>
          <div class="description {{#if open}}displayed{{/if}}" data-access="open">Everyone has access to the publication.</div>
          <div class="description {{#if closed}}displayed{{/if}}" data-access="closed">Only those who import the PDF have access to the publication.</div>
          <div class="description {{#if private}}displayed{{/if}}" data-access="private">Only the users who import the PDF or are listed have access to the publication.</div>
        </form>
        {{#if private}}
          {{> publicationPrivateAccessControl publication}}
        {{/if}}
      </div>
-->
      {{>publicationAccessControl publication}}
    </div>
  </div>
</template>

<!--
<template name="publicationPrivateAccessControl">
  <div class="private-access-control">
    <h3>Users</h3>
    <div class="access-list-area">
      <ol class="access-list access-list-users member-list">
        {{#each readUsers}}
          {{> groupMember}}
        {{/each}}
      </ol>
      <form class="add-user input-and-button">
        <input type="text" class="name" placeholder="Username" />
        <button type="submit" class="add">Add</button>
      </form>
    </div>
    <h3>Groups</h3>
    <div class="access-list-area">
      <ol class="access-list access-list-groups member-list">
        {{#each readGroups}}
          {{! TODO: Use some group template}}
          <li class="member"><h4>{{name}}</h4></li>
        {{/each}}
      </ol>
      <form class="add-group input-and-button">
        <input type="text" class="name" placeholder="Group name" />
        <button type="submit" class="add">Add</button>
      </form>
    </div>
  </div>
-->
<template name="publicationAccessControl">
  <form class="access publication-access">
    <input type="radio" value="open" name="publication-access-{{_id}}" id="publication-access-open-{{_id}}" {{#if open}}checked="checked"{{/if}} /> <label for="publication-access-open-{{_id}}"><i class="icon-public"></i> Open Access<span class="description">Everyone has access to the publication.</span></label><br/>
    <input type="radio" value="closed" name="publication-access-{{_id}}" id="publication-access-closed-{{_id}}" {{#if closed}}checked="checked"{{/if}} /> <label for="publication-access-closed-{{_id}}"><i class="icon-closed"></i> Closed Access<span class="description">Only those who import the PDF have access to the publication.</span></label><br/>
    <input type="radio" value="private" name="publication-access-{{_id}}" id="publication-access-private-{{_id}}" {{#if private}}checked="checked"{{/if}} /> <label for="publication-access-private-{{_id}}"><i class="icon-private"></i> Private<span class="description">Only the users who import the PDF or are listed have access to the publication.</span></label>
  </form>
  {{#if private}}
    {{> privateAccessControl}}
  {{/if}}
</template>

<template name="publicationDisplay">
  {{#if cached}}
    {{#constant}}
      <div class="display-wrapper"></div>
    {{/constant}}
  {{else}}
    <div class="display-wrapper closed-access">
      <h2>Publication is closed access</h2>
      <p>Publication is not open access and cannot be automatically displayed. Import its PDF to gain access.</p>
      {{! TODO: Should we report this to Open Access Button? }}
      {{! TODO: We should provide suggestions where to get PDF }}
      {{! TODO: We should probably show metadata here for users to easier copy out to search for PDF }}
      {{! TODO: We should link to user's open URL resolvers }}
    </div>
  {{/if}}
</template>

<template name="publicationScroller">
  <div class="scroller">
    {{#each sections}}
      {{> publicationScrollerSection}}
    {{/each}}
    <div class="viewport"></div>
  </div>
</template>

<template name="publicationScrollerSection">
  <div class="section" style="height: {{heightPercentage}}%; top: {{topPercentage}}%"></div>
</template>

<template name="publicationAnnotations">
  <ul class="annotations-list">
    {{#each annotations}}
      {{> publicationAnnotationsItem}}
    {{else}}
      {{> highlightInvite}}
    {{/each}}
  </ul>
</template>

<template name="publicationAnnotationsItem">
  <li class="annotation {{#if local}}local{{/if}} {{selected}}">
    {{#if local}}
      {{> annotationInvite}}
    {{else}}
      <img src="{{author.avatar}}" class="avatar" />
      <h4 class="author-name"><a href="{{profilePath author.slug}}">{{author.displayName}}</a></h4>
      {{#if selected}}
        {{#if canEdit}}
          {{> annotationEditor}}
        {{else}}
          <div class="body">{{body}}</div>
        {{/if}}
      {{else}}
        <div class="body" data-placeholder="{{#if canEdit}}Write your annotation here{{/if}}">{{body}}</div>
      {{/if}}
      {{> annotationMetaMenu}}
    {{/if}}
  </li>
</template>

<template name="annotationEditor">
  {{#constant}}
    <div class="body" contenteditable="true" data-placeholder="{{#if canEdit}}Write your annotation here{{/if}}">{{body}}</div>
    <span class="saved">Saved</span>
  {{/constant}}
</template>

<template name="highlightInvite">
  <li class="annotation invite">
    <div class="vertical-align-outer">
      <div class="vertical-align-inner">
        <div class="body balance-text">
          Select text in the publication to make a highlight, or click on an existing highlight to select it.
        </div>
      </div>
    </div>
  </li>
</template>

<template name="annotationInvite">
  <div class="body balance-text">
    {{! TODO: Change to "Click here or start typing to link an annotation to the selected highlight." }}
    Click here to link an annotation to the selected highlight.
  </div>
</template>

<template name="highlightsControl">
  {{#if canEdit}}
    <button class="delete">Delete</button>
  {{/if}}
  <p class="authors">
    {{#with author}}
      <span><a href="{{profilePath slug}}">{{displayName}}</a></span>
    {{/with}}
  </p>
  <p class="time">{{createdAt}}</p>
  <p class="time">{{updatedAt}}</p>
  <p class="annotations">
    {{#each annotations}}
      <span><a href="{{annotationPathFromId _id}}">a:{{_id}}</a></span>
    {{else}}
      Not linked to any annotation.
    {{/each}}
  </p>
  {{> accessControl}}
</template>

<template name="annotationsControl">
  <div class="annotations-control">
    <button class="icon-plus add" title="Add an annotation"></button>
  </div>
</template>

<template name="annotationMetaMenu">
  <div class="meta-menu">
    <i class="icon-menu"></i>
    <div class="meta-content">
      {{#if canEdit}}	    
        <button class="delete">Delete</button>
      {{/if}}
      <p class="authors">
        {{#with author}}
          <span><a href="{{profilePath slug}}">{{displayName}}</a></span>
        {{/with}}
      </p>
      <p class="time">{{createdAt}}</p>
      <p class="time">{{updatedAt}}</p>
      <p class="highlights">
        {{#each highlights}}
          <span><a href="{{highlightPathFromId _id}}">h:{{_id}}</a></span>
        {{else}}
          Not linked to any highlight.
        {{/each}}
      </p>
<!--
      <div class="access-panel">
        <form class="access annotation-access">
          <div class="selections">

            <label class="selection {{#if public}}selected{{/if}}" for="annotation-access-public-{{_id}}">
              <input type="radio" value="public" name="annotation-access-{{_id}}" id="annotation-access-public-{{_id}}" {{#if public}}checked="checked"{{/if}} />
              <i class="icon-closed"></i> Public
            </label>

            <label class="selection {{#if private}}selected{{/if}}" for="annotation-access-private-{{_id}}">
              <input type="radio" value="private" name="annotation-access-{{_id}}" id="annotation-access-private-{{_id}}" {{#if private}}checked="checked"{{/if}} />
              <i class="icon-private"></i> Private
            </label>

          </div>
          <div class="description {{#if public}}displayed{{/if}}" data-access="public">Everyone can see the annotation.</div>
          <div class="description {{#if private}}displayed{{/if}}" data-access="private">Only the users listed can see the annotation.</div>
        </form>
        {{#if private}}
        {{> publicationPrivateAccessControl publication}}
        {{/if}}
      </div>
-->
      {{> accessControl}}
    </div>
  </div>
</template>
