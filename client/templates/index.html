<template name="index">
  {{#if searchActive}}
    {{> results}}
  {{else}}
    {{> indexMain}}
    {{> indexStatistics}}
  {{/if}}
</template>

<template name="indexStatistics">
  <ul class="statistics">
    <li>
      <span class="value">{{publications}}</span>
      <span class="label">Publications</span>
    </li>
    <li>
      <span class="value">{{persons}}</span>
      <span class="label">People</span>
    </li>
  </ul>
</template>

<template name="indexMain">
  <script>
    var stage, renderer, ratio;

    function Vector(x, y) {
      this.originX = this.x = x || 0;
      this.originY = this.y = y || 0;
      this.deltaX = 0;
      this.deltaY = 0;
    }

    Vector.prototype.update = function(time) {
      var distance = Math.sin(
        Math.min(
          Math.abs(
            this.originY +
            0.5 * this.originX + 150 -
            (time/3) / 5 %
            (
               Math.max(window.innerWidth, window.innerHeight)
                 + 300
            )
          ) / Math.sqrt(1.25)
        , 200) / 200 * Math.PI / 2
      ) * 50;
      
      if(!this.duration || time > this.start + this.duration) {
        this.start = time;
         this.duration = Math.random() * 4000 + 5000;
        this.deltaX = Math.random() * 10;
        this.deltaY = Math.random() * 20;
      }
      var delta = (time - this.start) / this.duration
        , sin   = Math.sin(delta * Math.PI * 2);
      this.x = this.originX + sin * this.deltaX + distance;
      this.y = this.originY + sin * this.deltaY + distance;
    }  

    Vector.prototype.toString = function() {
      return "#<Vector x: " + this.x + ", y: " + this.y + ">";
    }

    function Triangle(v0, v1, v2) {
      this.v0 = v0 || new Vector();
      this.v1 = v1 || new Vector();
      this.v2 = v2 || new Vector();
      this.graphics = new PIXI.Graphics();
      stage.addChild(this.graphics);
    }

    Triangle.prototype.draw = function() {
      var graphics = this.graphics;
      graphics.clear();
      graphics.beginFill(this.color(), 0.2);
      graphics.lineStyle(1 * ratio, 0xFFFFFF, 0.4);
      graphics.moveTo(this.v0.x * ratio, this.v0.y * ratio);
      graphics.lineTo(this.v1.x * ratio, this.v1.y * ratio);
      graphics.lineTo(this.v2.x * ratio, this.v2.y * ratio);
      graphics.endFill();
    }

    Triangle.prototype.area = function() {
      return Math.abs(
        (this.v0.x * this.v1.y - this.v1.x * this.v0.y +
         this.v1.x * this.v2.y - this.v2.x * this.v1.y +
         this.v2.x * this.v0.y - this.v0.x * this.v2.y) / 2);
    }

    Triangle.prototype.color = function() {
      var h = (40 + this.area() / 100)/360;
      var s = (this.area() / 100)/100; 
      var l = (20 + this.area() /100)/100;
      //a = 0.2;
      return hslToRgb(h,s,l);
    }

    Triangle.prototype.toString = function() {
      return "#<Triangle v0: " +
        this.v0.toString() + ", v1: " +
        this.v1.toString() + ", v2: " +
        this.v2.toString() + ">";
    }

    function init() {

      renderer = PIXI.autoDetectRenderer(window.innerWidth, window.innerHeight);
      ratio = window.devicePixelRatio || 1;

      resizeCanvas();
      generateTriangles();

      document.body.appendChild(renderer.view);

      window.addEventListener("resize", resizeCanvas);
      window.addEventListener("resize", generateTriangles);

      requestAnimationFrame(draw);
    }

    function hslToRgb(h, s, l){
      var r, g, b;
      if(s == 0) {
        r = g = b = l;
      } else{
        function hue2rgb(p, q, t){
          if(t < 0) t += 1;
          if(t > 1) t -= 1;
          if(t < 1/6) return p + (q - p) * 6 * t;
          if(t < 1/2) return q;
          if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
            return p;
        }
        var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        var p = 2 * l - q;
        r = hue2rgb(p, q, h + 1/3);
        g = hue2rgb(p, q, h);
        b = hue2rgb(p, q, h - 1/3);
      }
      return ((r * 255) << 16) + ((g * 255) << 8) + (b * 255);
    }

    function draw(time) {
      for(var i = 0, len = vectors.length; i < len; i++) {
        vectors[i].update(time);
      }
      for(var i = 0, len = triangles.length; i < len; i++) {
        triangles[i].draw();
      }
      renderer.render(stage);
      requestAnimationFrame(draw);
    }

    function generateTriangles() {
      var originX = -200
        , originY = -200
        , width   = window.innerWidth + 280
        , height  = window.innerHeight + 280
        , deltaX  = 140
        , deltaY  = 52
        , columns = Math.ceil(width / deltaX)
        , rows    = Math.ceil(height / deltaY)
        , hash    = {};

       triangles = [];
       vectors   = [];
       stage = new PIXI.Stage(0xFFFFFF);

       function getVector(x, y) {
         var key = x + "," + y
         , value = hash[key];
         if(value) {
           return value;
         } else {
           var vector = new Vector(x, y);
           vectors.push(vector);
           hash[key] = vector;
           return vector;
         }
       }

       for(var i = 0; i < rows; i++) {
         for(var j = 0; j < columns; j++) {
           var x = originX + j * deltaX
             , y = originY + i * deltaY
             , o = i % 2
             , e = 1 - i % 2;
           triangles.push(new Triangle(
           getVector(x             , y + deltaY * o),
           getVector(x + deltaX / 2, y + deltaY * e),
           getVector(x + deltaX    , y + deltaY * o)
         ));
         triangles.push(new Triangle(
         getVector(x + deltaX / 2    , y + deltaY * e),
         getVector(x + deltaX        , y + deltaY * o),
         getVector(x + 3 * deltaX / 2, y + deltaY * e)
       ));
        }
      }
    }

    function resizeCanvas() {
      var canvas = renderer.view
        , height = window.innerHeight
        , width  = window.innerWidth;
      renderer.resize(width * ratio, height * ratio);
      canvas.width = width * ratio;
      canvas.height = height * ratio;
      canvas.style.width = width;
      canvas.style.height = ratio;
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>
  <div class="big-logo">
    <h1>PeerLibrary</h1>
  </div>
</template>
